/*! Cofoundry 2020-06-22 */
angular.module("cms.customEntities",["ngRoute","cms.shared"]).constant("_",window._).constant("customEntities.modulePath","/Admin/Modules/CustomEntities/Js/"),angular.module("cms.customEntities").config(["$routeProvider","shared.routingUtilities","customEntities.modulePath",function(a,b,c){b.registerCrudRoutes(a,c,"CustomEntity")}]),angular.module("cms.customEntities").controller("AddCustomEntityController",["$scope","$location","$q","$window","shared.stringUtilities","shared.LoadState","shared.customEntityService","shared.urlLibrary","customEntities.options",function(a,b,c,d,e,f,g,h,i){function j(){s.globalLoadState=new f,s.saveLoadState=new f,s.saveAndPublishLoadState=new f,s.formLoadState=new f(!0),s.editMode=!1,s.options=i,s.saveButtonText=i.autoPublish?"Save":"Save & Publish",s.saveAndEditButtonText=i.autoPublish?"Save & Edit Content":"Save Draft & Edit Content",s.save=k.bind(null,!1,n),s.saveAndPublish=k.bind(null,!0,n),s.saveAndEdit=k.bind(null,!1,o),s.cancel=m,s.onNameChanged=l,p()}function k(a,b){var c;a?(s.command.publish=!0,c=s.saveAndPublishLoadState):c=s.saveLoadState,q(c),g.add(s.command,i.customEntityDefinitionCode).then(b)["finally"](r.bind(null,c))}function l(){s.command.urlSlug=e.slugify(s.command.title)}function m(){b.path("/")}function n(a){b.path("/"+a)}function o(a){function b(b){var c=h.customEntityVisualEditor(b,!0);c?d.location.href=c:n(a)}return g.getById(a).then(b)}function p(){function b(a){s.command.model={},s.formDataSource={model:s.command.model,modelMetaData:a}}function c(a){s.pageRoutes=a}var d=g.getDataModelSchema(i.customEntityDefinitionCode).then(b),e=g.getPageRoutes(i.customEntityDefinitionCode).then(c);s.formLoadState.offWhen(d,e),s.command={},a.$watch("vm.command.localeId",function(a){a?s.additionalParameters={localeId:a}:s.additionalParameters={}})}function q(a){s.globalLoadState.on(),a&&_.isFunction(a.on)&&a.on()}function r(a){s.globalLoadState.off(),a&&_.isFunction(a.off)&&a.off()}var s=this;j()}]),angular.module("cms.customEntities").controller("CustomEntityDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.customEntityService","shared.urlLibrary","shared.permissionValidationService","customEntities.modulePath","customEntities.options",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){L.edit=o,L.save=p.bind(null,!1),L.saveAndPublish=p.bind(null,!0),L.cancel=q,L.publish=r,L.unpublish=s,L.discardDraft=t,L.copyToDraft=u,L.duplicate=v,L.deleteCustomEntity=w,L.changeUrl=x,L.editMode=!1,L.globalLoadState=new e,L.saveLoadState=new e,L.saveAndPublishLoadState=new e,L.formLoadState=new e(!0),L.versionsLoadState=new e,L.options=m,L.urlLibrary=j,L.saveButtonText=m.autoPublish?"Save":"Save & Publish",L.canChangeUrl=!m.autoGenerateUrlSlug||m.hasLocale,L.versionsQuery=new f({onChanged:B,useHistory:!1,defaultParams:{pageSize:6}}),L.canPublish=y("CMEPUB"),L.canUpdateUrl=y("UPDURL"),L.canDelete=y("COMDEL"),L.canUpdate=y("COMUPD"),L.canCreate=y("COMCRT"),A(L.formLoadState)}function o(){L.editMode=!0,L.mainForm.formStatus.clear()}function p(a){var b;a?(L.updateCommand.publish=!0,b=L.saveAndPublishLoadState):b=L.saveLoadState,I(b),i.updateDraft(L.updateCommand,m.customEntityDefinitionCode).then(z.bind(null,"Changes were saved successfully"))["finally"](J.bind(null,b))}function q(){L.editMode=!1,L.updateCommand=G(L.customEntity),L.mainForm.formStatus.clear()}function r(){h.publish(L.customEntity.customEntityId,I,N).then(z.bind(null,m.nameSingular+" published successfully."))["catch"](J)}function s(){h.unpublish(L.customEntity.customEntityId,I,N).then(z.bind(null,"The "+M+" has been unpublished and reverted to draft state."))["catch"](J)}function t(){function a(){return I(),i.removeDraft(L.customEntity.customEntityId)}var b={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since it was last published.",okButtonTitle:"Yes, discard it",onOk:a};g.confirm(b).then(z.bind(null,"Draft discarded successfully"))}function u(a){function b(){z("Draft created successfully.")}h.copyToDraft(L.customEntity.customEntityId,a.customEntityVersionId,L.customEntity.hasDraftVersion,I,N).then(b)["catch"](J)}function v(){g.show({templateUrl:l+"Routes/Modals/DuplicateCustomEntity.html",controller:"DuplicateCustomEntityController",options:{customEntity:L.customEntity}})}function w(){function a(){return I(),i.remove(L.customEntity.customEntityId).then(H)["catch"](J)}var b={title:"Delete "+m.nameSingular,message:"Are you sure you want to delete this "+M+"?",okButtonTitle:"Yes, delete it",onOk:a};g.confirm(b)}function x(){g.show({templateUrl:l+"Routes/Modals/ChangeUrl.html",controller:"ChangeUrlController",options:{customEntity:L.customEntity,onSave:z.bind(null,"Url Changed")}})}function y(a){return k.hasPermission(m.customEntityDefinitionCode+a)}function z(a,b){return A(b).then(L.mainForm.formStatus.success.bind(null,a))}function A(c){function d(a){var b=a[0],c=a[1];K=a[2],L.customEntity=b,D(b,c),L.updateCommand=G(b),L.isMarkedPublished="Published"==L.customEntity.publishStatus,L.publishStatusLabel=F(b),L.customEntity.locale?L.additionalParameters={localeId:L.customEntity.locale.localeId}:L.additionalParameters={},L.editMode=!1}function e(){return i.getDataModelSchema(m.customEntityDefinitionCode)}function f(){return i.getById(a.id)}return b.all([f(),C(),e()]).then(d).then(J.bind(null,c))}function B(){return L.versionsLoadState.on(),C().then(function(a){D(L.customEntity,a)}).then(J.bind(null,L.versionsLoadState))}function C(){return i.getVersionsByCustomEntityId(a.id,L.versionsQuery.getParameters())}function D(a,b){var c=(a.latestVersion.pages[0],a.isPublished());d.each(b.items,function(b){b.versionLabel=E(b,a),b.browseUrl=L.urlLibrary.visualEditorForVersion(a,b,!0,c)}),L.versions=b}function E(a,b){if("Draft"==a.workFlowStatus)return a.workFlowStatus;var c="V"+a.displayVersion;return a.isLatestPublishedVersion?c+" ("+F(b)+")":c}function F(a){return"Published"==a.publishStatus&&a.publishDate<Date.now()?"Pending Publish":a.publishStatus}function G(a){var b={customEntityId:a.customEntityId,title:a.latestVersion.title,model:angular.copy(a.latestVersion.model)};return L.formDataSource={model:b.model,modelMetaData:K},b}function H(){c.path("")}function I(a){L.globalLoadState.on(),a&&d.isFunction(a.on)&&a.on()}function J(a){L.globalLoadState.off(),a&&d.isFunction(a.off)&&a.off()}var K,L=this,M=m.nameSingular.toLowerCase(),N={entityNameSingular:m.nameSingular,isCustomEntity:!0};n()}]),angular.module("cms.customEntities").controller("CustomEntityListController",["$q","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.customEntityService","shared.permissionValidationService","shared.ModelPreviewFieldset","shared.ImagePreviewFieldCollection","customEntities.modulePath","customEntities.options",function(a,b,c,d,e,f,g,h,i,j,k){function l(){r.options=k,r.gridLoadState=new c,r.query=new d({onChanged:o}),r.filter=r.query.getFilters(),r.toggleFilter=m,r.changeOrdering=n,r.permissions=g,r.canUpdate=p("COMUPD"),r.canCreate=p("COMCRT"),m(!1),q()}function m(a){r.isFilterVisible=b.isUndefined(a)?!r.isFilterVisible:a}function n(){e.show({templateUrl:j+"Routes/Modals/ChangeOrdering.html",controller:"ChangeOrderingController",options:{localeId:r.filter.localeId,onSave:q}})}function o(){m(!1),q()}function p(a){return g.hasPermission(k.customEntityDefinitionCode+a)}function q(){function b(){return r.gridLoadState.on(),f.getAll(r.query.getParameters(),k.customEntityDefinitionCode).then(function(a){r.result=a,r.gridLoadState.off()})}function c(){return f.getDataModelSchema(k.customEntityDefinitionCode)}function d(a){r.previewFields=new h(a)}function e(){return r.gridImages=new i,r.gridImages.load(r.result.items,r.previewFields)}var g,j=b();return r.previewFields?(g=a.defer(),g.resolve()):g=c().then(d),a.all([g,j]).then(e)}var r=this;l()}]),angular.module("cms.customEntities").controller("ChangeOrderingController",["$scope","$q","$location","_","shared.LoadState","shared.arrayUtilities","shared.internalModulePath","shared.modalDialogService","shared.customEntityService","customEntities.options","options","close",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){a.options=j,a.command={localeId:k.localeId,customEntityDefinitionCode:j.customEntityDefinitionCode},a.isPartialOrdering="Partial"===j.ordering,a.submitLoadState=new e,a.formLoadState=new e(!0),a.gridLoadState=new e,a.save=n,a.close=l,a.setStep=u,a.onLocalesLoaded=o,a.onDrop=p,a.remove=q,a.showPicker=r,t()}function n(){a.command.orderedCustomEntityIds=s(),a.submitLoadState.on(),i.updateOrdering(a.command).then(k.onSave).then(l)["finally"](a.submitLoadState.off)}function o(){a.formLoadState.off()}function p(b,c){f.moveObject(a.gridData,c,b,w)}function q(b){f.removeObject(a.gridData,b)}function r(){function b(b){if(b&&b.length){var c=d.filter(a.gridData,function(a){return!d.contains(b,a[w])});a.gridData=d.difference(a.gridData,c);var e=d.difference(b,s());e.length&&(a.gridLoadState.on(),i.getByIdRange(e).then(function(b){a.gridData=d.union(a.gridData,b),a.gridLoadState.off()}))}else a.gridData=[]}h.show({templateUrl:g+"UIComponents/CustomEntities/CustomEntityPickerDialog.html",controller:"CustomEntityPickerDialogController",options:{selectedIds:s(),customEntityDefinition:j,filter:{localeId:a.command.localeId},onSelected:b}})}function s(){return d.pluck(a.gridData,w)}function t(){j.hasLocale?(a.allowStep1=!0,u(1)):(u(2),a.formLoadState.off())}function u(b){a.currentStep=b,2===b&&v()}function v(){function b(b){a.isPartialOrdering?a.gridData=d.filter(b.items,function(a){return!!a.ordering}):a.gridData=b.items,a.formLoadState.off()}a.formLoadState.on();var c={pageSize:60,localeId:a.command.localeId,interpretNullLocaleAsNone:!0};i.getAll(c,j.customEntityDefinitionCode).then(b)}var w="customEntityId";m()}]),angular.module("cms.customEntities").controller("ChangeUrlController",["$scope","$q","$location","shared.LoadState","shared.customEntityService","customEntities.options","options","close",function(a,b,c,d,e,f,g,h){function i(){var b=g.customEntity;a.options=f,a.customEntity=b,a.command={customEntityId:b.customEntityId,localeId:b.locale?b.locale.localeId:void 0,urlSlug:b.urlSlug},a.submitLoadState=new d,a.formLoadState=new d(f.hasLocale),a.save=j,a.close=h,a.localesLoaded=k.resolve,a.formLoadState.offWhen(k)}function j(){a.submitLoadState.on(),e.updateUrl(a.command).then(g.onSave).then(h)["finally"](a.submitLoadState.off)}var k=b.defer();i()}]),angular.module("cms.customEntities").controller("DuplicateCustomEntityController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.customEntityService","customEntities.options","options","close",function(a,b,c,d,e,f,g,h,i){function j(){k(),a.submitLoadState=new e,a.formLoadState=new e(g.hasLocale),a.customEntityDefinition=g,a.save=m,a.close=i,a.onTitleChanged=l,a.localesLoaded=o.resolve,a.formLoadState.offWhen(o)}function k(){var b=h.customEntity;a.customEntity=b,a.command={customEntityToDuplicateId:b.customEntityId,localeId:b.locale?b.locale.localeId:void 0,title:"Copy of "+b.latestVersion.title},l()}function l(){a.command.urlSlug=d.slugify(a.command.title)}function m(){a.submitLoadState.on(),f.duplicate(a.command).then(n).then(i)["finally"](a.submitLoadState.off)}function n(a){c.path("/"+a)}var o=b.defer();j()}]);
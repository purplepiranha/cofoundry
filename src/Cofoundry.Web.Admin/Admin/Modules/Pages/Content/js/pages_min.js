/*! Cofoundry 2020-06-22 */
angular.module("cms.pages",["ngRoute","cms.shared"]).constant("_",window._).constant("pages.modulePath","/Admin/Modules/Pages/Js/"),angular.module("cms.pages").config(["$routeProvider","shared.routingUtilities","pages.modulePath",function(a,b,c){var d=b.mapOptions.bind(null,c);a.when("/new",d("AddPage")).when("/:id",d("PageDetails")).otherwise(d("PageList"))}]),angular.module("cms.pages").factory("pages.customEntityService",["$http","shared.serviceBase",function(a,b){var c={};return c.getAllRoutingRules=function(){return a.get(b+"custom-entity-routing-rules/")},c}]),angular.module("cms.pages").factory("pages.directoryService",["$http","_","shared.serviceBase",function(a,b,c){var d={},e=c+"page-directories";return d.getAll=function(){return a.get(e)},d}]),angular.module("cms.pages").factory("pages.pageTemplateService",["$http","$q","shared.serviceBase",function(a,b,c){var d={},e=c+"page-templates";return d.getAll=function(){var c=b.defer();return a.get(e).then(function(a){c.resolve(a.items)},c.reject),c.promise},d}]),angular.module("cms.pages").controller("AddPageController",["_","$q","$location","$window","shared.LoadState","shared.stringUtilities","shared.urlLibrary","shared.pageService","pages.pageTemplateService","pages.customEntityService",function(a,b,c,d,e,f,g,h,i,j){function k(){u.save=l.bind(null,!1,m),u.saveAndPublish=l.bind(null,!0,m),u.saveAndEdit=l.bind(null,!1,n),u.cancel=q,u.onNameChanged=o,u.onPageTypeChanged=p,u.globalLoadState=new e,u.saveLoadState=new e,u.saveAndPublishLoadState=new e,u.formLoadState=new e(!0),u.onLocalesLoaded=v.resolve,u.onPageDirectoriesLoaded=w.resolve,r()}function l(a,b){var c;a?(u.command.publish=!0,c=u.saveAndPublishLoadState):c=u.saveLoadState,s(c),h.add(u.command).then(b)["finally"](t.bind(null,c))}function m(a){c.path("/"+a)}function n(a){function b(a){d.location.href=g.visualEditorForPage(a.pageRoute,!0)}return h.getById(a).then(b)}function o(){u.command.urlPath=f.slugify(u.command.title)}function p(){var b=u.command.pageType,c="CustomEntityDetails"==b?b:"Generic";u.pageTemplates=a.where(u.allPageTemplates,{pageType:c})}function q(){c.path("/")}function r(){u.pageTypes=h.getPageTypes(),u.command={showInSiteMap:!0,pageType:u.pageTypes[0].value};var a=i.getAll().then(function(a){u.allPageTemplates=a}),b=j.getAllRoutingRules().then(function(a){u.routingRules=a});u.formLoadState.offWhen(v,w,a,b).then(p)}function s(b){u.globalLoadState.on(),b&&a.isFunction(b.on)&&b.on()}function t(b){u.globalLoadState.off(),b&&a.isFunction(b.off)&&b.off()}var u=this,v=b.defer(),w=b.defer();k()}]),angular.module("cms.pages").controller("PageDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.urlLibrary","shared.pageService","shared.permissionValidationService","pages.modulePath",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){I.edit=n,I.save=o.bind(null,!1),I.saveAndPublish=o.bind(null,!0),I.cancel=p,I.publish=q,I.unpublish=r,I.discardDraft=s,I.copyToDraft=t,I.deletePage=u,I.duplicatePage=v,I.changeUrl=w,I.editMode=!1,I.globalLoadState=new e,I.saveLoadState=new e,I.saveAndPublishLoadState=new e,I.formLoadState=new e(!0),I.versionsLoadState=new e,I.urlLibrary=i,I.versionsQuery=new f({onChanged:z,useHistory:!1,defaultParams:{pageSize:6}}),I.canCreate=k.canCreate("COFPGE"),I.canUpdate=k.canUpdate("COFPGE"),I.canDelete=k.canDelete("COFPGE"),I.canPublishPage=k.hasPermission("COFPGEPAGPUB"),I.canUpdatePageUrl=k.hasPermission("COFPGEUPDURL"),y(I.formLoadState)}function n(){I.editMode=!0,I.mainForm.formStatus.clear()}function o(a){var b;a?(I.updateDraftCommand.publish=!0,b=I.saveAndPublishLoadState):b=I.saveLoadState,G(b),j.update(I.updatePageCommand).then(j.updateDraft.bind(this,I.updateDraftCommand)).then(x.bind(null,"Changes were saved successfully"))["finally"](H.bind(null,b))}function p(){I.editMode=!1,I.updatePageCommand=D(I.page),I.updateDraftCommand=E(I.page),I.mainForm.formStatus.clear()}function q(){h.publish(I.page.pageId,G).then(x.bind(null,"Page published successfully."))["catch"](H)}function r(){h.unpublish(I.page.pageId,G).then(x.bind(null,"The page has been unpublished and reverted to draft state."))["catch"](H)}function s(){function a(){return G(),j.removeDraft(I.page.pageId)}var b={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since the page was last published.",okButtonTitle:"Yes, discard it",onOk:a};g.confirm(b).then(x.bind(null,"Draft discarded successfully"))}function t(a){function b(){x("Draft created successfully.")}h.copyToDraft(I.page.pageId,a.pageVersionId,I.page.pageRoute.hasDraftVersion,G).then(b)["catch"](H)}function u(){function a(){return G(),j.remove(I.page.pageId).then(F)["catch"](H)}var b={title:"Delete Page",message:"Are you sure you want to delete this page?",okButtonTitle:"Yes, delete it",onOk:a};g.confirm(b)}function v(){g.show({templateUrl:l+"Routes/Modals/DuplicatePage.html",controller:"DuplicatePageController",options:{page:I.page}})}function w(){g.show({templateUrl:l+"Routes/Modals/ChangePageUrl.html",controller:"ChangePageUrlController",options:{page:I.page,onSave:x.bind(null,"Url Changed")}})}function x(a,b){return y(b).then(I.mainForm.formStatus.success.bind(null,a))}function y(c){function d(){return j.getById(a.id).then(function(a){return I.page=a,I.updatePageCommand=D(a),I.updateDraftCommand=E(a),I.editMode=!1,I.isMarkedPublished="Published"==I.page.pageRoute.publishStatus,I.publishStatusLabel=C(a.pageRoute),a})}return b.all([d(),A()]).then(function(a){B(a[1])}).then(H.bind(null,c))}function z(){return I.versionsLoadState.on(),A().then(B).then(H.bind(null,I.versionsLoadState))}function A(){return j.getVersionsByPageId(a.id,I.versionsQuery.getParameters())}function B(a){function b(a,b){if("Draft"==a.workFlowStatus)return a.workFlowStatus;var c="V"+a.displayVersion;return a.isLatestPublishedVersion?c+" ("+C(b)+")":c}var c=I.page,e=c.pageRoute.isPublished();d.each(a.items,function(a){a.versionLabel=b(a,c.pageRoute),a.browseUrl=I.urlLibrary.visualEditorForVersion(c.pageRoute,a,!1,e)}),I.versions=a}function C(a){return"Published"==a.publishStatus&&a.publishDate<Date.now()?"Pending Publish":a.publishStatus}function D(a){return{pageId:a.pageId,tags:a.tags}}function E(a){var b=a.latestVersion,c=b.openGraph;return{pageId:a.pageId,title:b.title,metaDescription:b.metaDescription,openGraphTitle:c.title,openGraphDescription:c.description,openGraphImageId:c.image?c.image.ImageAssetId:void 0,showInSiteMap:b.showInSiteMap}}function F(){c.path("")}function G(a){I.globalLoadState.on(),a&&d.isFunction(a.on)&&a.on()}function H(a){I.globalLoadState.off(),a&&d.isFunction(a.off)&&a.off()}var I=this;m()}]),angular.module("cms.pages").controller("PageListController",["_","shared.entityVersionModalDialogService","shared.LoadState","shared.SearchQuery","shared.pageService","shared.permissionValidationService","pages.pageTemplateService",function(a,b,c,d,e,f,g){function h(){l(),n.gridLoadState=new c,n.globalLoadState=new c,n.query=new d({onChanged:k}),n.filter=n.query.getFilters(),n.toggleFilter=i,i(!1),n.publish=j,n.canCreate=f.canCreate("COFPGE"),n.canUpdate=f.canUpdate("COFPGE"),m()}function i(b){n.isFilterVisible=a.isUndefined(b)?!n.isFilterVisible:b}function j(a){b.publish(a,n.globalLoadState.on).then(m).then(n.globalLoadState.off)["catch"](n.globalLoadState.off)}function k(){i(!1),m()}function l(){n.publishStatus=[{name:"Unpublished"},{name:"Published"}],g.getAll().then(function(a){n.pageTemplates=a})}function m(){return n.gridLoadState.on(),e.getAll(n.query.getParameters()).then(function(a){n.result=a,n.gridLoadState.off()})}var n=this;h()}]),angular.module("cms.pages").controller("ChangePageUrlController",["$scope","$q","$location","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(a,b,c,d,e,f,g,h){function i(){j(),a.submitLoadState=new d,a.formLoadState=new d(!0),a.save=l,a.close=h,a.localesLoaded=m.resolve,a.pageDirectoriesLoaded=n.resolve,a.formLoadState.offWhen(m,n,k())}function j(){var b=g.page,c=b.pageRoute;a.isCustomEntityRoute="CustomEntityDetails"===c.pageType,a.page=b,a.command={pageId:b.pageId,localeId:c.locale?c.locale.localeId:void 0,pageDirectoryId:c.pageDirectory.pageDirectoryId},a.isCustomEntityRoute?a.command.customEntityRoutingRule=c.urlPath:a.command.urlPath=c.urlPath}function k(){if(a.isCustomEntityRoute)return f.getAllRoutingRules().then(function(b){a.routingRules=b});var c=b.defer();return c.resolve(),c}function l(){a.submitLoadState.on(),e.updateUrl(a.command).then(g.onSave).then(h)["finally"](a.submitLoadState.off)}var m=b.defer(),n=b.defer();i()}]),angular.module("cms.pages").controller("DuplicatePageController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(a,b,c,d,e,f,g,h,i){function j(){k(),a.submitLoadState=new e,a.formLoadState=new e(!0),a.save=n,a.close=i,a.onTitleChanged=l,a.localesLoaded=p.resolve,a.pageDirectoriesLoaded=q.resolve,a.formLoadState.offWhen(p,q,m())}function k(){var b=h.page,c=b.pageRoute;a.isCustomEntityRoute="CustomEntityDetails"===c.pageType,a.page=b,a.command={pageToDuplicateId:b.pageId,localeId:c.locale?c.locale.localeId:void 0,pageDirectoryId:c.pageDirectory.pageDirectoryId,title:"Copy of "+b.latestVersion.title},a.isCustomEntityRoute?a.command.customEntityRoutingRule=c.urlPath:l()}function l(){a.isCustomEntityRoute||(a.command.urlPath=d.slugify(a.command.title))}function m(){if(a.isCustomEntityRoute)return g.getAllRoutingRules().then(function(b){a.routingRules=b});var c=b.defer();return c.resolve(),c}function n(){a.submitLoadState.on(),f.duplicate(a.command).then(o).then(i)["finally"](a.submitLoadState.off)}function o(a){c.path("/"+a)}var p=b.defer(),q=b.defer();j()}]);